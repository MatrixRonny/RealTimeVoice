<html>
<head>
    <title>OpenAI Realtime Voice</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@openai/realtime@latest/dist/realtime.js"></script>

    <style>
        .voice-text-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .voice-text-box {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .voice-label {
            font-weight: bold;
            margin-bottom: 5px;
        }

        textarea[readonly] {
            resize: none;
            width: 100%;
            height: 150px;
            font-size: 1em;
            padding: 8px;
            box-sizing: border-box;
        }
    </style>
</head>
<body onload="init()">
    <h1>OpenAI Realtime Voice</h1>
    <p>This example shows how to use OpenAI's Realtime Voice API to stream audio from your microphone and receive audio responses from the model.</p>

    <div class="voice-text-container">
        <div class="voice-text-box">
            <span class="voice-label">User Voice (Text)</span>
            <textarea id="userVoiceText" readonly></textarea>
        </div>
        <div class="voice-text-box">
            <span class="voice-label">AI Voice (Text)</span>
            <textarea id="aiVoiceText" readonly></textarea>
        </div>
    </div>
</body>
</html>

<script>
    async function startVoiceChatOverWebRTC() {
        // Get an ephemeral key from your server - see server code below
        const tokenResponse = await fetch("/session");
        const data = await tokenResponse.json();
        const EPHEMERAL_KEY = data.client_secret.value;

        // Create a peer connection
        const pc = new RTCPeerConnection();

        // Set up to play remote audio from the model
        const audioEl = document.createElement("audio");
        audioEl.autoplay = true;
        pc.ontrack = e => audioEl.srcObject = e.streams[0];

        // Add local audio track for microphone input in the browser
        const ms = await navigator.mediaDevices.getUserMedia({
            audio: true
        });
        pc.addTrack(ms.getTracks()[0]);

        // Set up data channel for sending and receiving events
        const dc = pc.createDataChannel("oai-events");
        dc.addEventListener("message", (e) => {
            // Realtime server events appear here!
            console.log(e);
        });

        // Start the session using the Session Description Protocol (SDP)
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        const baseUrl = "https://api.openai.com/v1/realtime";
        const model = "gpt-4o-realtime-preview-2025-06-03";
        const sdpResponse = await fetch(`${baseUrl}?model=${model}`, {
            method: "POST",
            body: offer.sdp,
            headers: {
                Authorization: `Bearer ${EPHEMERAL_KEY}`,
                "Content-Type": "application/sdp"
            },
        });

        const answer = {
            type: "answer",
            sdp: await sdpResponse.text(),
        };
        await pc.setRemoteDescription(answer);
    }
</script>